---
title: "透视矫正插值公式的推导"
date: 2022-11-11T19:12:20+08:00
categories: ["图形"]
---

## 前言

众所周知（？） vertex shader 里顶点属性转换成 pixel shader 里逐像素属性需要经过插值，具体来说，是根据像素所在三角形三个顶点的属性，以像素点的重心坐标为权重进行插值。这里的重心坐标不一定是屏幕空间的重心坐标，取决于插值的属性是否使用 `noperspective` 关键字修饰。一般的属性都需要经过透视矫正，[OpenGL spec](https://registry.khronos.org/OpenGL/specs/gl/glspec46.core.pdf) 里给出了矫正公式（见 Basic Polygon Rasterization 一节），但没有给出推导。网络上通常的推导多数是先考虑二维上线段的属性，得到一个透视矫正公式，再类比它与线性插值公式，推广到三维，直接给出重心坐标的透视矫正算法。

事实上，直接在三维下推导出矫正公式也不困难，甚至不需要求交点坐标（以及解方程）就可以得出。

## 推导过程

已知空间中一个三角形的三个顶点为 $A,B,C$, 经过投影矩阵到 NDC 空间下的齐次坐标是 $(X_A, Y_A, Z_A, W_A)$, $(X_B, Y_B, Z_B, W_B)$, $(X_C, Y_C, Z_C, W_C)$, 这里 $W_A, W_B, W_C$ 就是对应的顶点在相机空间下的实际深度. 三角形 $ABC$ 投影到屏幕上仍然是一个三角形, 各顶点的屏幕空间坐标分别是 
$$A'=(\dfrac{X_A}{W_A},\dfrac{Y_A}{W_A}), \qquad B'=(\dfrac{X_B}{W_B},\dfrac{Y_B}{W_B}),\qquad C'=(\dfrac{X_C}{W_C},\dfrac{Y_C}{W_C}). $$
对屏幕上的三角形进行光栅化, 得到一组像素坐标. 对于其中的每个像素, 假设其屏幕空间的二维坐标是 $P'=(u,v)$, 需要求出此处 $A,B,C$ 三个顶点的权重, 以便对顶点属性进行插值. 假设像素 $P'$ 对应于三维空间三角形 $ABC$ 上的点为 $P$, 它的齐次坐标为 $(X_P, Y_P, Z_P, W_P)$, 由 $P$ 点在三角形 $ABC$ 内可得
$$
\begin{align}
X_P &= a\cdot X_A + b\cdot X_B + c\cdot X_C \tag{1} \\\ 
Y_P &= a\cdot Y_A + b\cdot Y_B + c\cdot Y_C \tag{2} \\\ 
W_P &= a\cdot W_A + b\cdot W_B + c\cdot W_C \tag{3}
\end{align}
$$
这里 $a,b,c$ 为 $P$ 的重心坐标, 满足$0\le a,b,c \le 1$, 且
$$a+b+c=1 \tag{4} $$


<div>
<center>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300pt" height="200pt" viewBox="80 60 300 200" version="1.1">
<defs>
<g>
<symbol overflow="visible" id="glyph0-0">
<path style="stroke:none;" d=""/>
</symbol>
<symbol overflow="visible" id="glyph0-1">
<path style="stroke:none;" d="M 6.796875 -2.484375 C 6.796875 -2.578125 6.625 -2.828125 6.5 -2.828125 C 6.390625 -2.828125 6.203125 -2.59375 6.203125 -2.5 C 6.125 -1.0625 5.234375 -0.421875 4.140625 -0.421875 C 3.53125 -0.421875 1.75 -0.59375 1.75 -3.5625 C 1.75 -6.546875 3.53125 -6.71875 4.140625 -6.71875 C 5.21875 -6.71875 5.9375 -5.96875 6.125 -4.515625 C 6.15625 -4.375 6.328125 -4.1875 6.46875 -4.1875 C 6.625 -4.1875 6.796875 -4.375 6.796875 -4.578125 L 6.796875 -6.953125 C 6.796875 -7.125 6.625 -7.359375 6.515625 -7.359375 C 6.484375 -7.359375 6.3125 -7.3125 6.234375 -7.1875 L 5.828125 -6.59375 C 5.609375 -6.8125 4.984375 -7.359375 4.03125 -7.359375 C 2.15625 -7.359375 0.375 -5.609375 0.375 -3.5625 C 0.375 -1.5 2.171875 0.21875 4.03125 0.21875 C 5.65625 0.21875 6.796875 -1.328125 6.796875 -2.484375 Z M 6.796875 -2.484375 "/>
</symbol>
<symbol overflow="visible" id="glyph0-2">
<path style="stroke:none;" d="M 4.984375 -1.046875 L 4.984375 -1.78125 L 4.390625 -1.78125 L 4.390625 -1.046875 C 4.390625 -0.46875 4.3125 -0.578125 4.203125 -0.578125 C 3.875 -0.578125 4 -0.859375 4 -0.90625 L 4 -2.90625 C 4 -3.3125 3.953125 -3.828125 3.59375 -4.203125 C 3.203125 -4.578125 2.59375 -4.796875 2.109375 -4.796875 C 1.296875 -4.796875 0.421875 -4.15625 0.421875 -3.5 C 0.421875 -3.203125 0.8125 -2.875 1.0625 -2.875 C 1.34375 -2.875 1.6875 -3.234375 1.6875 -3.484375 C 1.6875 -3.609375 1.46875 -4.109375 1.34375 -4.109375 C 1.40625 -4.1875 1.78125 -4.25 2.09375 -4.25 C 2.578125 -4.25 2.96875 -4.015625 2.96875 -3.125 L 2.96875 -2.921875 C 2.640625 -2.90625 1.9375 -2.875 1.3125 -2.578125 C 0.5625 -2.234375 0.140625 -1.546875 0.140625 -1.109375 C 0.140625 -0.296875 1.28125 0.109375 1.90625 0.109375 C 2.578125 0.109375 3.203125 -0.453125 3.390625 -0.921875 L 3.046875 -0.921875 C 3.078125 -0.515625 3.53125 0.0625 4 0.0625 C 4.203125 0.0625 4.984375 -0.234375 4.984375 -1.046875 Z M 2.96875 -1.5625 C 2.96875 -0.609375 2.4375 -0.4375 1.984375 -0.4375 C 1.5 -0.4375 1.25 -0.625 1.25 -1.109375 C 1.25 -1.671875 1.5 -2.328125 2.96875 -2.375 Z M 2.96875 -1.5625 "/>
</symbol>
<symbol overflow="visible" id="glyph0-3">
<path style="stroke:none;" d="M 8.28125 -0.15625 L 8.28125 -0.640625 C 7.59375 -0.640625 7.5 -0.46875 7.5 -0.765625 L 7.5 -2.671875 C 7.5 -3.53125 7.453125 -3.953125 7.140625 -4.3125 C 7 -4.484375 6.546875 -4.734375 5.96875 -4.734375 C 5.140625 -4.734375 4.515625 -3.96875 4.34375 -3.59375 L 4.6875 -3.59375 C 4.5625 -4.453125 3.65625 -4.734375 3.203125 -4.734375 C 2.46875 -4.734375 1.828125 -4.140625 1.546875 -3.515625 L 1.890625 -3.515625 L 1.890625 -4.75 L 0.140625 -4.609375 L 0.140625 -3.984375 C 1.015625 -3.984375 0.921875 -4.078125 0.921875 -3.59375 L 0.921875 -0.921875 C 0.921875 -0.46875 0.984375 -0.640625 0.140625 -0.640625 L 0.140625 0.015625 L 1.453125 -0.03125 L 2.734375 0.015625 L 2.734375 -0.640625 C 1.890625 -0.640625 1.953125 -0.46875 1.953125 -0.921875 L 1.953125 -2.75 C 1.953125 -3.78125 2.5 -4.1875 3.125 -4.1875 C 3.765625 -4.1875 3.6875 -3.8125 3.6875 -3.234375 L 3.6875 -0.921875 C 3.6875 -0.46875 3.765625 -0.640625 2.90625 -0.640625 L 2.90625 0.015625 L 4.21875 -0.03125 L 5.5 0.015625 L 5.5 -0.640625 C 4.671875 -0.640625 4.71875 -0.46875 4.71875 -0.921875 L 4.71875 -2.75 C 4.71875 -3.78125 5.265625 -4.1875 5.90625 -4.1875 C 6.53125 -4.1875 6.453125 -3.8125 6.453125 -3.234375 L 6.453125 -0.921875 C 6.453125 -0.46875 6.53125 -0.640625 5.6875 -0.640625 L 5.6875 0.015625 L 6.984375 -0.03125 L 8.28125 0.015625 Z M 8.28125 -0.15625 "/>
</symbol>
<symbol overflow="visible" id="glyph0-4">
<path style="stroke:none;" d="M 4.3125 -1.34375 C 4.3125 -1.453125 4.0625 -1.640625 4 -1.640625 C 3.921875 -1.640625 3.71875 -1.40625 3.703125 -1.328125 C 3.34375 -0.296875 2.625 -0.46875 2.53125 -0.46875 C 2.03125 -0.46875 1.75 -0.71875 1.53125 -1.09375 C 1.21875 -1.5625 1.28125 -2.109375 1.28125 -2.296875 L 3.890625 -2.296875 C 4.109375 -2.296875 4.3125 -2.46875 4.3125 -2.671875 C 4.3125 -3.65625 3.59375 -4.796875 2.359375 -4.796875 C 1.203125 -4.796875 0.09375 -3.59375 0.09375 -2.359375 C 0.09375 -1.015625 1.328125 0.109375 2.46875 0.109375 C 3.6875 0.109375 4.3125 -1.15625 4.3125 -1.34375 Z M 3.484375 -2.84375 L 1.296875 -2.84375 C 1.34375 -4.15625 2.015625 -4.25 2.359375 -4.25 C 3.375 -4.25 3.296875 -3.0625 3.296875 -2.84375 Z M 3.484375 -2.84375 "/>
</symbol>
<symbol overflow="visible" id="glyph0-5">
<path style="stroke:none;" d="M 3.796875 -3.953125 C 3.796875 -4.28125 3.3125 -4.734375 2.890625 -4.734375 C 2.15625 -4.734375 1.625 -3.890625 1.484375 -3.46875 L 1.828125 -3.46875 L 1.828125 -4.75 L 0.09375 -4.609375 L 0.09375 -3.984375 C 0.984375 -3.984375 0.875 -4.078125 0.875 -3.59375 L 0.875 -0.921875 C 0.875 -0.46875 0.953125 -0.640625 0.09375 -0.640625 L 0.09375 0.015625 L 1.421875 -0.03125 C 1.8125 -0.03125 2.28125 -0.03125 2.84375 0.015625 L 2.84375 -0.640625 L 2.46875 -0.640625 C 1.734375 -0.640625 1.890625 -0.578125 1.890625 -0.9375 L 1.890625 -2.46875 C 1.890625 -3.453125 2.140625 -4.1875 2.890625 -4.1875 C 2.953125 -4.1875 2.84375 -4.234375 2.875 -4.234375 L 3 -4.5 C 2.96875 -4.5 2.59375 -4.203125 2.59375 -3.953125 C 2.59375 -3.671875 2.984375 -3.359375 3.203125 -3.359375 C 3.375 -3.359375 3.796875 -3.640625 3.796875 -3.953125 Z M 3.796875 -3.953125 "/>
</symbol>
<symbol overflow="visible" id="glyph1-0">
<path style="stroke:none;" d=""/>
</symbol>
<symbol overflow="visible" id="glyph1-1">
<path style="stroke:none;" d="M 1.65625 -1.421875 C 1.25 -0.75 1 -0.671875 0.5625 -0.640625 C 0.4375 -0.625 0.171875 -0.453125 0.171875 -0.265625 C 0.171875 -0.203125 0.40625 0 0.484375 0 C 0.75 0 1.0625 -0.03125 1.328125 -0.03125 C 1.671875 -0.03125 2.015625 0 2.328125 0 C 2.390625 0 2.6875 -0.15625 2.6875 -0.34375 C 2.6875 -0.453125 2.4375 -0.640625 2.359375 -0.640625 C 2.140625 -0.65625 2.0625 -0.5625 2.0625 -0.8125 C 2.0625 -0.9375 2.078125 -0.9375 2.15625 -1.078125 L 2.875 -2.296875 L 5.140625 -2.296875 C 5.140625 -2.25 5.28125 -0.890625 5.28125 -0.796875 C 5.28125 -0.5 4.9375 -0.640625 4.734375 -0.640625 C 4.59375 -0.640625 4.3125 -0.46875 4.3125 -0.265625 C 4.3125 -0.15625 4.609375 0 4.640625 0 C 5.046875 0 5.46875 -0.03125 5.875 -0.03125 C 6.125 -0.03125 6.765625 0 7.015625 0 C 7.0625 0 7.359375 -0.15625 7.359375 -0.359375 C 7.359375 -0.46875 7.09375 -0.640625 6.953125 -0.640625 C 6.34375 -0.640625 6.515625 -0.53125 6.484375 -0.828125 L 5.875 -7.0625 C 5.859375 -7.25 5.6875 -7.46875 5.515625 -7.46875 C 5.359375 -7.46875 5.1875 -7.34375 5.125 -7.25 Z M 3.09375 -2.65625 L 5.0625 -5.953125 L 4.765625 -6.0625 L 5.078125 -2.9375 L 3.265625 -2.9375 Z M 3.09375 -2.65625 "/>
</symbol>
<symbol overflow="visible" id="glyph1-2">
<path style="stroke:none;" d="M 1.421875 -0.9375 C 1.3125 -0.546875 1.46875 -0.640625 0.6875 -0.640625 C 0.515625 -0.640625 0.234375 -0.46875 0.234375 -0.265625 C 0.234375 -0.15625 0.515625 0 0.6875 0 L 4.25 0 C 5.828125 0 7.171875 -1.328125 7.171875 -2.3125 C 7.171875 -3.03125 6.421875 -3.78125 5.453125 -3.890625 L 5.453125 -3.5625 C 6.484375 -3.75 7.703125 -4.640625 7.703125 -5.59375 C 7.703125 -6.328125 6.875 -7.140625 5.6875 -7.140625 L 2.328125 -7.140625 C 2.140625 -7.140625 1.859375 -6.96875 1.859375 -6.765625 C 1.859375 -6.65625 2.140625 -6.5 2.328125 -6.5 C 2.34375 -6.5 2.53125 -6.5 2.703125 -6.484375 C 2.875 -6.453125 2.796875 -6.609375 2.796875 -6.484375 C 2.796875 -6.4375 2.78125 -6.40625 2.75 -6.296875 Z M 3.265625 -3.8125 L 3.890625 -6.28125 C 3.984375 -6.625 3.828125 -6.5 4.25 -6.5 L 5.546875 -6.5 C 6.421875 -6.5 6.453125 -6.078125 6.453125 -5.625 C 6.453125 -4.75 5.765625 -3.984375 4.5625 -3.984375 L 3.3125 -3.984375 Z M 2.65625 -0.640625 C 2.515625 -0.640625 2.5 -0.640625 2.4375 -0.640625 C 2.328125 -0.65625 2.46875 -0.5 2.46875 -0.578125 C 2.46875 -0.609375 2.46875 -0.625 2.515625 -0.8125 L 3.171875 -3.421875 L 4.921875 -3.421875 C 5.875 -3.421875 5.890625 -2.84375 5.890625 -2.421875 C 5.890625 -1.4375 5.1875 -0.640625 4 -0.640625 Z M 2.65625 -0.640625 "/>
</symbol>
<symbol overflow="visible" id="glyph1-3">
<path style="stroke:none;" d="M 7.75 -7.09375 C 7.75 -7.125 7.5625 -7.359375 7.46875 -7.359375 C 7.4375 -7.359375 7.296875 -7.296875 7.1875 -7.1875 L 6.640625 -6.578125 C 6.65625 -6.5625 6.078125 -7.359375 4.96875 -7.359375 C 2.734375 -7.359375 0.3125 -4.984375 0.3125 -2.671875 C 0.3125 -1.03125 1.671875 0.21875 3.203125 0.21875 C 4.0625 0.21875 4.9375 -0.234375 5.46875 -0.6875 C 6.40625 -1.5 6.625 -2.515625 6.625 -2.546875 C 6.625 -2.65625 6.34375 -2.828125 6.328125 -2.828125 C 6.265625 -2.828125 6.046875 -2.625 6.015625 -2.546875 C 5.9375 -2.265625 5.75 -1.671875 5.0625 -1.09375 C 4.375 -0.53125 3.875 -0.421875 3.359375 -0.421875 C 2.46875 -0.421875 1.578125 -0.765625 1.578125 -2.328125 C 1.578125 -2.890625 1.734375 -4.390625 2.734375 -5.5625 C 3.34375 -6.265625 4.15625 -6.71875 5.046875 -6.71875 C 6.0625 -6.71875 6.46875 -6.109375 6.46875 -4.953125 C 6.46875 -4.5625 6.4375 -4.546875 6.4375 -4.453125 C 6.4375 -4.34375 6.734375 -4.1875 6.765625 -4.1875 C 6.890625 -4.1875 7.0625 -4.359375 7.125 -4.546875 Z M 7.75 -7.09375 "/>
</symbol>
<symbol overflow="visible" id="glyph1-4">
<path style="stroke:none;" d="M 3.015625 -3.15625 L 4.71875 -3.15625 C 6.125 -3.15625 7.6875 -4.34375 7.6875 -5.46875 C 7.6875 -6.234375 6.859375 -7.140625 5.546875 -7.140625 L 2.328125 -7.140625 C 2.140625 -7.140625 1.84375 -6.96875 1.84375 -6.78125 C 1.84375 -6.65625 2.109375 -6.5 2.3125 -6.5 C 2.4375 -6.5 2.625 -6.484375 2.734375 -6.484375 C 2.90625 -6.453125 2.78125 -6.59375 2.78125 -6.484375 C 2.78125 -6.4375 2.765625 -6.40625 2.734375 -6.296875 L 1.40625 -0.9375 C 1.3125 -0.546875 1.46875 -0.640625 0.671875 -0.640625 C 0.515625 -0.640625 0.21875 -0.46875 0.21875 -0.28125 C 0.21875 -0.15625 0.515625 0 0.546875 0 C 0.828125 0 1.53125 -0.03125 1.8125 -0.03125 C 2.03125 -0.03125 2.25 -0.015625 2.453125 -0.015625 C 2.671875 -0.015625 2.890625 0 3.09375 0 C 3.171875 0 3.46875 -0.15625 3.46875 -0.359375 C 3.46875 -0.46875 3.203125 -0.640625 3.015625 -0.640625 C 2.65625 -0.640625 2.546875 -0.46875 2.546875 -0.640625 C 2.546875 -0.703125 2.5625 -0.75 2.578125 -0.8125 L 3.15625 -3.15625 Z M 3.90625 -6.28125 C 4 -6.625 3.84375 -6.5 4.28125 -6.5 L 5.234375 -6.5 C 6.0625 -6.5 6.40625 -6.390625 6.40625 -5.703125 C 6.40625 -5.3125 6.265625 -4.578125 5.875 -4.21875 C 5.375 -3.765625 4.90625 -3.734375 4.46875 -3.734375 L 3.265625 -3.734375 Z M 3.90625 -6.28125 "/>
</symbol>
<symbol overflow="visible" id="glyph2-0">
<path style="stroke:none;" d=""/>
</symbol>
<symbol overflow="visible" id="glyph2-1">
<path style="stroke:none;" d="M 2.21875 -3.453125 C 2.265625 -3.5625 2.28125 -3.625 2.28125 -3.671875 C 2.28125 -3.890625 1.890625 -4.21875 1.671875 -4.21875 C 1.40625 -4.21875 1.125 -3.84375 1.09375 -3.734375 L 0.171875 -0.703125 C 0.21875 -0.8125 0.125 -0.609375 0.125 -0.59375 C 0.125 -0.515625 0.546875 -0.28125 0.609375 -0.28125 C 0.65625 -0.28125 0.859375 -0.453125 0.90625 -0.5625 Z M 2.21875 -3.453125 "/>
</symbol>
</g>
</defs>
<g id="surface1">
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,69.999695%,69.999695%);fill-opacity:1;" d="M 226.511719 143.332031 L 204.726563 150.242188 L 237.140625 189.03125 Z M 226.511719 143.332031 "/>
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(69.999695%,100%,69.999695%);fill-opacity:1;" d="M 231.296875 99.226563 L 226.511719 143.332031 L 237.140625 189.03125 Z M 231.296875 99.226563 "/>
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(69.999695%,69.999695%,100%);fill-opacity:1;" d="M 231.296875 99.226563 L 204.726563 150.242188 L 226.511719 143.332031 Z M 231.296875 99.226563 "/>
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,69.999695%,69.999695%);fill-opacity:1;" d="M 289.046875 150.589844 L 278.785156 166.378906 L 351.835938 243.140625 Z M 289.046875 150.589844 "/>
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(69.999695%,100%,69.999695%);fill-opacity:1;" d="M 283.746094 85.644531 L 289.046875 150.589844 L 351.835938 243.140625 Z M 283.746094 85.644531 "/>
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(69.999695%,69.999695%,100%);fill-opacity:1;" d="M 283.746094 85.644531 L 278.785156 166.378906 L 289.046875 150.589844 Z M 283.746094 85.644531 "/>
<path style="fill:none;stroke-width:0.99628;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -113.387219 141.734906 L -113.387219 28.348187 L -56.691906 0.00053125 L -56.691906 113.38725 Z M -113.387219 141.734906 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill:none;stroke-width:0.99628;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -79.266125 115.879437 L -105.836437 64.863812 L -73.422375 26.07475 Z M -79.266125 115.879437 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill:none;stroke-width:0.99628;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -26.816906 129.461469 L -31.777844 48.727094 L 41.272938 -28.034625 Z M -26.816906 129.461469 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill:none;stroke-width:0.99628;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(50%,50%,50%);stroke-opacity:1;stroke-dasharray:2.98883,2.98883;stroke-miterlimit:10;" d="M -198.426281 85.039594 L -79.266125 115.879437 L -26.816906 129.461469 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill:none;stroke-width:0.99628;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(50%,50%,50%);stroke-opacity:1;stroke-dasharray:2.98883,2.98883;stroke-miterlimit:10;" d="M -198.426281 85.039594 L -105.836437 64.863812 L -31.777844 48.727094 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill:none;stroke-width:0.99628;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(50%,50%,50%);stroke-opacity:1;stroke-dasharray:2.98883,2.98883;stroke-miterlimit:10;" d="M -198.426281 85.039594 L -73.422375 26.07475 L 41.272938 -28.034625 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill:none;stroke-width:0.99628;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(50%,50%,50%);stroke-opacity:1;stroke-dasharray:2.98883,2.98883;stroke-miterlimit:10;" d="M -198.426281 85.039594 L -84.051281 71.773969 L -21.516125 64.516156 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph0-1" x="95.243" y="140.609"/>
  <use xlink:href="#glyph0-2" x="102.435997" y="140.609"/>
  <use xlink:href="#glyph0-3" x="107.417297" y="140.609"/>
  <use xlink:href="#glyph0-4" x="115.716143" y="140.609"/>
  <use xlink:href="#glyph0-5" x="120.139537" y="140.609"/>
  <use xlink:href="#glyph0-2" x="124.044877" y="140.609"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-1" x="280.011" y="82.126"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-2" x="267.21" y="176.706"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-3" x="347.919" y="253.469"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-4" x="285.158" y="147.069"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-4" x="221.226" y="139.813"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph2-1" x="229.005" y="136.198"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-1" x="217.509" y="102.973"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph2-1" x="224.981" y="99.358"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-2" x="199.301" y="161.251"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph2-1" x="207.357" y="157.636"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph1-3" x="231.827" y="200.042"/>
</g>
<g style="fill:rgb(0%,0%,0%);fill-opacity:1;">
  <use xlink:href="#glyph2-1" x="239.66" y="196.427"/>
</g>
<path style="fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.79701;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -78.270031 115.879437 C -78.270031 116.430219 -78.715344 116.875531 -79.266125 116.875531 C -79.816906 116.875531 -80.262219 116.430219 -80.262219 115.879437 C -80.262219 115.328656 -79.816906 114.883344 -79.266125 114.883344 C -78.715344 114.883344 -78.270031 115.328656 -78.270031 115.879437 Z M -78.270031 115.879437 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.79701;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -104.840344 64.863812 C -104.840344 65.414594 -105.285656 65.859906 -105.836437 65.859906 C -106.387219 65.859906 -106.832531 65.414594 -106.832531 64.863812 C -106.832531 64.313031 -106.387219 63.867719 -105.836437 63.867719 C -105.285656 63.867719 -104.840344 64.313031 -104.840344 64.863812 Z M -104.840344 64.863812 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.79701;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -72.426281 26.07475 C -72.426281 26.625531 -72.871594 27.070844 -73.422375 27.070844 C -73.973156 27.070844 -74.418469 26.625531 -74.418469 26.07475 C -74.418469 25.523969 -73.973156 25.078656 -73.422375 25.078656 C -72.871594 25.078656 -72.426281 25.523969 -72.426281 26.07475 Z M -72.426281 26.07475 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.79701;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -83.055187 71.773969 C -83.055187 72.32475 -83.5005 72.770062 -84.051281 72.770062 C -84.602062 72.770062 -85.047375 72.32475 -85.047375 71.773969 C -85.047375 71.223187 -84.602062 70.777875 -84.051281 70.777875 C -83.5005 70.777875 -83.055187 71.223187 -83.055187 71.773969 Z M -83.055187 71.773969 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.79701;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -197.430187 85.039594 C -197.430187 85.590375 -197.8755 86.035687 -198.426281 86.035687 C -198.977062 86.035687 -199.422375 85.590375 -199.422375 85.039594 C -199.422375 84.488812 -198.977062 84.0435 -198.426281 84.0435 C -197.8755 84.0435 -197.430187 84.488812 -197.430187 85.039594 Z M -197.430187 85.039594 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.79701;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -25.820812 129.461469 C -25.820812 130.008344 -26.266125 130.457562 -26.816906 130.457562 C -27.367687 130.457562 -27.813 130.008344 -27.813 129.461469 C -27.813 128.910687 -27.367687 128.465375 -26.816906 128.465375 C -26.266125 128.465375 -25.820812 128.910687 -25.820812 129.461469 Z M -25.820812 129.461469 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.79701;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -30.78175 48.727094 C -30.78175 49.277875 -31.227062 49.723187 -31.777844 49.723187 C -32.328625 49.723187 -32.773937 49.277875 -32.773937 48.727094 C -32.773937 48.176312 -32.328625 47.731 -31.777844 47.731 C -31.227062 47.731 -30.78175 48.176312 -30.78175 48.727094 Z M -30.78175 48.727094 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.79701;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 42.269031 -28.034625 C 42.269031 -27.483844 41.823719 -27.038531 41.272938 -27.038531 C 40.722156 -27.038531 40.276844 -27.483844 40.276844 -28.034625 C 40.276844 -28.585406 40.722156 -29.030719 41.272938 -29.030719 C 41.823719 -29.030719 42.269031 -28.585406 42.269031 -28.034625 Z M 42.269031 -28.034625 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
<path style="fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.79701;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M -20.520031 64.516156 C -20.520031 65.066937 -20.965344 65.51225 -21.516125 65.51225 C -22.066906 65.51225 -22.512219 65.066937 -22.512219 64.516156 C -22.512219 63.965375 -22.066906 63.520062 -21.516125 63.520062 C -20.965344 63.520062 -20.520031 63.965375 -20.520031 64.516156 Z M -20.520031 64.516156 " transform="matrix(1,0,0,-1,310.563,215.106)"/>
</g>
</svg>
</center>
</div>





$a,b,c$ 均为未知量, 需要根据 $P$ 点的屏幕坐标 $P'$ 求出. $A',B',C'$ 与 $P'$ 都是二维屏幕空间上的点, 仍然满足线性插值关系, 只是重心坐标会发生变化, 假设 $(u,v)$ 满足
\\[P' = r\cdot A' + s\cdot B' + t\cdot C'.\\]
展开可得
$$
\begin{align}
u &= r\cdot\frac{X_A}{W_A} + s\cdot\frac{X_B}{W_B} + t\cdot\frac{X_C}{W_C} \tag{5} \\\ 
v &= r\cdot\frac{Y_A}{W_A} + s\cdot\frac{Y_B}{W_B} + t\cdot\frac{Y_C}{W_C} \tag{6}
\end{align}
$$
这里 $r,s,t$ 是 $P'$ 在三角形 $A'B'C'$的重心坐标, 满足 $0\le r,s,t\le 1$, 且
\\[r+s+t=1 \tag{7} \\]
通过求解 $(5),(6),(7)$ 可以求出 $r,s,t$ .事实上求解重心坐标的标准方法是通过面积比, 但本质都一样. 因此实质上 $r,s,t$ 的值也是已知的.

一般情况下, $r,s,t$ 的值与 $a,b,c$ 并不相等, 因为它们满足的关系不同. 由 $P$ 和 $P'$ 的投影关系有
$$u=\dfrac{X_P}{W_P},\qquad v=\dfrac{Y_P}{W_P}$$ 并结合 $(1)(2)$ 可得
$$
\begin{align*}
a\cdot X_A + b\cdot X_B + c\cdot X_C &= u\cdot W_P \\\ 
a\cdot Y_A + b\cdot Y_B + c\cdot Y_C &= v\cdot W_P 
\end{align*}
$$
两式分别除以$W_P$, 得
$$
\begin{align*}
a\cdot\frac{W_A}{W_P}\cdot \frac{X_A}{W_A} + b\cdot\frac{W_B}{W_P}\cdot \frac{X_B}{W_B}+ c\cdot\frac{W_C}{W_P}\cdot \frac{X_C}{W_C} &= u \\\ 
a\cdot\frac{W_A}{W_P}\cdot \frac{Y_A}{W_A} + b\cdot\frac{W_B}{W_P}\cdot \frac{Y_B}{W_B}+ c\cdot\frac{W_C}{W_P}\cdot \frac{Y_C}{W_C} &= v 
\end{align*}
$$
观察到只要令 
$$r = \frac{a\cdot W_A}{W_P}, \qquad s = \frac{b\cdot W_B}{W_P},\qquad t = \frac{c\cdot W_C}{W_P}, $$
则 $(5)(6)(7)$ 都是满足的. 将:
\\[ a = \frac{r\cdot W_P}{W_A}, \qquad b = \frac{s\cdot W_P}{W_B}, \qquad c = \frac{t\cdot W_P}{W_C} \\]
代入 $(4)$, 可得
\\[W_P = \left( \frac{r}{W_A}+ \frac{s}{W_B} + \frac{t}{W_C} \right)^{-1} .\\]
将 $W_P$ 代回去就能求出 $a,b,c$ 的值了.

## Bonus: 深度的插值

前面一直忽略了 $Z$ 坐标，现在考虑以下的问题：已知三角形 $ABC$ 三个顶点的齐次坐标，并得到三个顶点的深度缓冲值为 $d_i = \dfrac{Z_i}{W_i}, i=A,B,C $，如何插值得到内部像素 $P$ 点的深度呢？

由三维空间下的重心坐标系数有
$$
\begin{align*}
Z_P &= a\cdot Z_A + b\cdot Z_B + c\cdot Z_C \\\ 
&= \frac{r\cdot W_P Z_A}{W_A} + \frac{s\cdot W_P Z_B}{W_B} + \frac{t\cdot W_P Z_C}{W_C} \\\ 
&= r\cdot d_A W_P + s\cdot d_B W_P + t\cdot d_C W_P
\end{align*}
$$

$P$ 点的深度值为 
$$ d_P = \frac{Z_P}{W_P} = r\cdot d_A + s\cdot d_B + t\cdot d_C $$

可见三角形内部的深度值只需要根据顶点深度值按屏幕空间的重心坐标系数进行插值即可，不需要进行透视矫正。



