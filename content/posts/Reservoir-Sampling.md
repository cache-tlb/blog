---
title: "蓄水池采样算法"
date: 2021-12-13T19:23:32+08:00
categories: ["数学"]
toc:
    enable: true
---

## 问题

从数据流中源源不断读入数据，事先不知道数据流长度是多少，要在读完的时候选出其中的 $N$ 个元素，怎么做才能使每个元素都以均等的概率被选中。其障碍在于，数据流很长，无法全部存下，所以需要在数据第一次到达时立即做出决策。

这就是著名的蓄水池采样问题（Reservoir Sampling），经常会出现在程序员和华尔街面试中。Knuth 的大作 TAOCP (The Art Of Computer Programming) 在第3.4.2节讨论了这个问题。


## 思路

假设数据流已经流过了 $k$ 个数据，我们应用某种策略选取了其中的 $N$ 项作为候选。此时数据流可能结束了，将这些候选项作为返回结果即可。但也有可能数据流没结束，如果新过来一个数据，我们需要对候选项做一些调整。因为候选项里的那些元素到目前为止被选出的概率实际上是 $\dfrac{N}{k}$，我们希望是 $\dfrac{N}{k+1}$，这需要将原来的候选项的某个元素剔除，换成新来的这个数据，这样新来的数据也有机会成为候选。


## 算法

维护一个长度为 $N$ 的数组，作为蓄水池，存放当前的候选结果。对于数据流的前 $N$ 个数据，我们直接将它们放进蓄水池里；蓄水池满了之后，对于数据流的第 $k$ 个数据（$k > N$），随机生成一个 $[1,k]$ 之间的整数 $j$，如果 $j \le N$，就将蓄水池里下标为 $j$ 的元素替换成新来的数据，否则将新来的数据扔掉。


## 证明

假设数据流总长度是 $L$，其中第 $k$ 号元素最终被选中需要满足下面两个条件：
1. 该元素到来时被加入蓄水池；
2. 后面的元素不会将它替换掉。

$k\le N$ 时，条件 1 恒成立，条件 2 成立的概率是 $\dfrac{N}{N+1}\cdot\dfrac{N+1}{N+2}\cdots\dfrac{L-1}{L}=\dfrac{N}{L}$。

$k>N$ 时，条件 1 成立的概率是 $\dfrac{N}{k}$，条件 2 成立的概率是 $\dfrac{k}{k+1}\cdot\dfrac{k+1}{k+2}\cdots\dfrac{L-1}{L}$，两个概率乘起来就是 $\dfrac{N}{L}$。

所以无论哪种情况，每个元素最终留在蓄水池里的概率都是相等的。

## 推广

更一般的问题是，数据流的每个数据有不同的权重，希望在数据流结束时按权重作为概率选出 $N$ 个元素。原问题相当于所有数据权重都是 1 的特例。

如果按照类似的思路会怎样呢？很容易将原算法做如下的推广。用一个蓄水池存 $N$ 个候选以及对应的权重，并且再用一个累加器存储到目前为止的数据流的权重之和。记第 $k$ 个数据权重为 $w_k$，前 $k$ 个数据权重之和为 $S_k$。第 $k$ 个数据到来时，随机生成一个 $[0, S_M]$ 之间的实数 $r$，如果 $r$ 大于当前蓄水池的权重之和，则扔掉新来的数据，否则根据轮盘赌算法确定 $r$ 位于蓄水池权重的第几个区间，替换掉对应位置的数据，并且更新蓄水池的权重数组。

实际上并没有那么顺利，可以证明这样的策略不能达到要求的采样概率。事实上，稍微深入推敲一下推广版问题的细节，会发现一些不明确或者说有歧义的地方。考虑一个比较极端的具体例子，假设数据流总长度 $L=100$，抽样个数 $N=10$，前 99 个数据权重都是 $w_1=\cdots=w_{99}=1$，最后一个数据权重为 $w_{100}=891$，权重之和为 990，最后一个数据占比为 0.9，前99个数据权重之和占比才只有 0.1，是否意味着期望来看，最后一个数据应该被抽到 9 次呢？

如果是可重复的采样，先看 $N=1$ 的情况，此时蓄水池只保留一个数据，不会出现重复采样的问题。这样之前的思路又可以正常工作了。对于第 $k$ 个数据，随机生成一个 $[0, S_k]$ 之间的实数 $r$，如果 $r<w_k$，就替换掉现有蓄水池数据，否则扔掉新来的数据。每个数据被加入蓄水池的概率为 $\dfrac{w_k}{S_k}$，不被替换的概率为 $\dfrac{S_{k+1}-w_{k+1}}{S_{k+1}}\cdots\dfrac{S_L-w_L}{S_L}$。乘起来就是 $\dfrac{w_k}{S_L}$。

$N>1$ 又如何呢？我们可以重复对蓄水池每个槽位独立地应用 $N=1$ 时的处理方法。这样就保证了任意阶段每个数据在蓄水池内的期望个数正比于它的权重。

<!-->
再讨论不重复的采样。为了明确抽样的目标，我们先去掉数据流的约束，假设所有数据和权重都在内存里，可以随时被访问到。初始时数据集为 $X=\\{x_1,\cdots,x_L\\}$，找到权重最大的，假设是 $x_i$，如果它的期望抽中次数 $(w_i\cdot N)/S_L \ge 1$，就将它选入抽中的样本里，同时更新数据集： $X\leftarrow X- \\{x_i\\}$，$L\leftarrow L-1$，更新剩余抽样个数：$N\leftarrow N-1$，并重新计算 $S_L\leftarrow S_L-w_i$。直到剩余数据的期望抽中次数小于1。
<!-->

如果样本允许重复，则是更复杂的问题，有机会再好好研究一下。
