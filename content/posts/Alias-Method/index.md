---
title: "于 Alias 采样算法中领悟天之道"
date: 2022-12-15T19:25:05+08:00
categories: ["图形"]
toc:
    enable: false
---

给定了一个离散概率分布，如何从中采样？这虽然是一个简单问题，但在许多领域都会涉及到。例如遗传算法中，给出种群每个个体的适应度，要从中筛选出一些个体存活，个体存活的概率正比于适应度。又例如计算 Image Based Lighting 时，我们希望按照亮度值从环境贴图上采样，越亮的方向越有可能被采样到，这也是符合重要性采样原则的。

标准方法是轮盘赌算法（roulette selection）。算法名字也非常形象，初始化时每个选项根据 PDF 大小占据轮盘上的一块扇形区间，每次采样时发射一个小球，在轮盘上滚动，小球最终落在哪个选项上。在一些文献中，这个算法又被称为俄罗斯轮盘赌算法（Russian roulette），但俄罗斯轮盘赌的玩法跟采样看不出有什么联系，疑为讹传。

<center>
{{< image src="European_roulette.svg"  caption="轮盘赌" title=" " width="100%" >}}
</center>

随机一个轮盘赌上的小球位置，为了确定小球落在哪个选项上，只要知道每个选项所占据区间的起止位置，然后遍历所有选项挨个判断即可。但这样做每次采样都要遍历一遍，复杂度太大。一个显而易见的改进方法是先算出 CDF，再用二分查找，可在 log 时间内找到随机数对应的选项。

是否还能进一步优化呢？答案是可以的。借由 Alias 采样算法，可以每次用常数时间获取样本。Alias 算法的流程和实现细节在 [这个链接](https://www.keithschwarz.com/darts-dice-coins/)和 [Wikipedia](https://en.wikipedia.org/wiki/Alias_method) 都有详细介绍。笔者十分欣赏这个简单而优美的算法，不禁要转述一遍。

假设有 $N$ 个选项，最理想的情况就是所有选项权重一样，此时 CDF 被分成了 $N$ 个等大小的区间，可以在常数时间判断一个随机数落在第几个区间。进一步， 如果每个选项的权重大小不等，要是能将它们的权重匀一匀，权重小的找权重大的借一点，凑到平均值为止，就能凑出 $N$ 个等大小的 CDF 区间；选出一个区间后，再在区间内部再采样即可。需要满足每个区间内只有常数个样本。 Alias 算法可以满足这一点，只要还没凑够 $N$ 个区间，就一定存在一个权重低于平均值和一个权重高于平均值的候选，从后者拿出一部分权重让前者凑够，这样每个选项最多只要向一个其他选项借权重，被借方就称为借方的 Alias。被借方借出之后可能自己的权重又不足了，此时它也会成为借方。下面用一个例子演示。

假设有 4 个选项，权重分别是 6，4，1，1，平均权重为 3。
<center>
{{< image src="Alias.1.svg" title=" " width="75%" >}}
</center>

当前存在一个权重不足的选项 2，找选项 0 补足。
<center>
{{< image src="Alias.2.svg" title=" " width="75%" >}}
</center>

继续用选项 0 补足选项 3 的权重。
<center>
{{< image src="Alias.3.svg" title=" " width="75%" >}}
</center>

但此时选项 0 的权重不够了，找选项 1 凑。
<center>
{{< image src="Alias.4.svg" title=" " width="75%" >}}
</center>

这样刚好凑够 4 个权重相等的组合，每个组合里最多包含两个选项，并且每个组合的两个选项占比也已知。采样时先根据第一个随机数选出一个组合，再根据第二个随机数从组合中选出一个选项。每个都只要常数时间。

老子有云：“天之道，损有余而补不足”。 Alias 算法正是符合这一哲学，甚至奉行得更彻底。当有余的部分不够补齐不足的部分时，还要拿出多的来，优先将不足的补全。虽然最终都将归于平均，但在 Alias 算法“劫富济贫”的过程中，富余的一方也要经历一段贫穷的时间，再到达平均。

